# Playbook: New Feature

**Goal**: Build a new feature or product with validated demand, clear retention architecture, and defensibility strategy.

## Prerequisites (REQUIRED Before Building)

**No feature may enter engineering without all 5 prerequisites:**

1. **Insight Brief** (`/docs/product/INSIGHT-<product>.md`)
   - Unfair insight validated
   - Target community identified
   - Distribution wedge clear

2. **Narrative PRD** (`/docs/product/PRD-<product>.md`)
   - Value Story clear
   - Desirability validated (3+ tests passed)
   - Early adopter profile defined
   - JTBD Frequency Modeling complete

3. **Retention Architecture** (`/docs/product/RETENTION-<product>.md`)
   - Activation path designed
   - Weekly/monthly value drivers mapped
   - Notification/re-engagement triggers defined
   - Churn-prevention design complete

4. **Moat + MRR Strategy** (`/docs/product/MOAT-MRR-<product>.md`)
   - 2-3 moat types selected
   - Data Moat Thesis complete
   - Expansion revenue model defined
   - Retention thesis clear

5. **Portfolio Greenlight** (`/docs/product/PORTFOLIO-SCORE-<idea>.md`)
   - Portfolio score calculated
   - Expected value modeled
   - Verdict: "Proceed"

**Rule**: No exceptions. All 5 prerequisites must be complete before engineering.

## Step Sequence

```
Prerequisites Complete → Design Phase → Engineering Phase → Verification Phase

Design Phase:
1. @UX-Researcher → User research (if needed)
2. @IA-Designer → IA/flows/edge cases

Engineering Phase:
3. @Engineering-Architect → ADR + schema + router plan
4. @Test-Engineer → Test plan + stubs
5. @Implementer → Build (small diffs, MVP-first)

Verification Phase:
6. @Accessibility-Agent → A11y audit + fix loop
7. @Test-Engineer → Test verify
8. @Product-Strategist → PRD acceptance check
```

## Steps

### Design Phase

#### 1. @UX-Researcher → User Research (if needed)

**Input**: Insight Brief, Narrative PRD  
**Output**: User research findings  
**Agent**: UX Researcher

**Optional**: Only if research gaps exist

**Deliverables**:
- User interview scripts
- Research synthesis
- Narrative resonance tests
- Identity-pain questions

**Quality Gate**: Research findings align with Insight Brief and PRD

#### 2. @IA-Designer → IA/Flows/Edge Cases

**Input**: Narrative PRD, Retention Architecture  
**Output**: IA document + user flows  
**Agent**: IA Designer

**Required Artifacts**:
- IA document in `docs/ux/IA-<feature>.md`
- User flows (Mermaid diagrams)
- Happy path + failure paths
- Empty/loading/error states
- Permissions-based variants
- Keyboard/focus expectations
- Emotional peak, aha moment, story resolution identified

**Deliverables**:
- Complete IA document
- User flows documented
- Edge cases identified
- Interaction patterns defined

**Quality Gate**: All user flows complete, edge cases covered, emotional journey mapped

### Engineering Phase

#### 3. @Engineering-Architect → ADR + Schema + Router Plan

**Input**: Narrative PRD, IA document, Retention Architecture, Moat + MRR Strategy  
**Output**: ADR + technical plan  
**Agent**: Engineering Architect

**Required Artifacts**:
- ADR in `docs/engineering/ADR/NNNN-<feature>.md`
- Schema plan (Drizzle)
- Router plan (tRPC)
- Tenancy scoping plan
- Runtime choice (nodejs/edge)
- Data capture instrumentation plan (for Data Moat)
- Expansion revenue implementation plan
- Defensibility enablers noted (if relevant)

**Deliverables**:
- ADR complete
- Technical plan documented
- Schema designed
- Router structure planned
- Data moat instrumentation planned

**Quality Gate**: ADR complete, technical plan clear, schema/router aligned with PRD

#### 4. @Test-Engineer → Test Plan + Stubs

**Input**: ADR, Narrative PRD, Retention Architecture  
**Output**: Test plan + test stubs  
**Agent**: Test Engineer

**Required Artifacts**:
- Unit tests for domain logic
- Integration tests for routers/actions + DB
- E2E tests for critical journeys
- Tests keyed to acceptance criteria
- Invariants explicit
- Realistic seed scenarios

**Deliverables**:
- Test plan documented
- Test stubs created
- Acceptance criteria mapped to tests
- Test coverage plan clear

**Quality Gate**: All acceptance criteria have tests, test plan complete

#### 5. @Implementer → Build (Small Diffs, MVP-First)

**Input**: ADR, Test plan, IA document  
**Output**: Working code  
**Agent**: Implementer

**Required Artifacts**:
- Code in `src/features/<feature>/*`
- Route shells in `/app` routes
- Passing tests
- Observability events + flags
- Data capture instrumentation (for Data Moat)
- Expansion revenue implementation
- All UI states (loading, empty, error, success)

**Deliverables**:
- Feature code complete
- Tests passing
- UI states implemented
- Data capture instrumented
- Expansion revenue mechanisms implemented

**Quality Gate**: Tests green, code follows feature module boundaries, MVP-first, small diffs

### Verification Phase

#### 6. @Accessibility-Agent → A11y Audit + Fix Loop

**Input**: Working code  
**Output**: A11y audit + fixes  
**Agent**: Accessibility Agent

**Required Artifacts**:
- A11y audit in `docs/ux/A11Y-AUDIT-<feature>.md`
- WCAG 2.2 AA compliance
- Keyboard navigation verified
- Screen reader labels verified
- Touch targets verified
- Contrast verified

**Deliverables**:
- A11y audit complete
- Critical issues fixed
- Serious issues fixed
- Minor issues documented (fix later)

**Quality Gate**: No critical or serious a11y issues remain

#### 7. @Test-Engineer → Test Verify

**Input**: Complete code + fixes  
**Output**: Test verification report  
**Agent**: Test Engineer

**Required Artifacts**:
- All tests passing
- Coverage report
- E2E tests verified
- Edge cases tested
- Acceptance criteria verified

**Deliverables**:
- Test verification complete
- All tests green
- Coverage meets requirements
- Edge cases covered

**Quality Gate**: All tests green, coverage adequate, edge cases verified

#### 8. @Product-Strategist → PRD Acceptance Check

**Input**: Complete feature  
**Output**: Acceptance decision  
**Agent**: Product Strategist

**Required Artifacts**:
- PRD acceptance criteria verified
- Value Story delivered
- Retention architecture implemented
- Data capture instrumented
- Expansion revenue mechanisms implemented
- All UI states present

**Deliverables**:
- Acceptance decision (Accept | Reject)
- Acceptance notes
- Follow-up items (if any)

**Quality Gate**: All acceptance criteria met, PRD delivered

## Definition of Done

Feature is considered done when:

- ✅ All 5 prerequisites complete before engineering
- ✅ Design phase complete (IA + flows documented)
- ✅ Engineering phase complete (ADR + tests + code)
- ✅ Verification phase complete (A11y + tests + acceptance)
- ✅ All tests green
- ✅ No critical/serious a11y issues
- ✅ PRD acceptance criteria met
- ✅ Data capture instrumented (for Data Moat)
- ✅ Expansion revenue mechanisms implemented
- ✅ All UI states present (loading, empty, error, success)
- ✅ Observability events added
- ✅ Feature flags configured (if needed)
- ✅ Documentation updated
- ✅ Ready for deployment

## Rules

- **All prerequisites required**: No feature may enter engineering without all 5 prerequisites complete
- **No build until validated**: Building before validation is forbidden (`.cursor/rules/027-core-desirability-first.mdc`)
- **Small diffs**: Keep changes small and incremental
- **MVP-first**: Build smallest surface area to validate or expand narrative
- **Tests define correctness**: Tests must pass before deployment
- **A11y required**: No critical/serious a11y issues allowed

## Integration

This playbook integrates with:
- `.cursor/rules/200-playbook-insight-validation.mdc` - Insight validation (prerequisite)
- `.cursor/rules/027-core-desirability-first.mdc` - Desirability first (enforces prerequisites)
- `.cursor/rules/001-core-architecture.mdc` - Architecture principles
- `.cursor/rules/005-core-testing.mdc` - Testing requirements
- `.cursor/rules/010-core-ux-a11y.mdc` - UX and accessibility
- `.cursor/rules/170-data-moat.mdc` - Data moat implementation
- `.cursor/rules/180-expansion-revenue.mdc` - Expansion revenue implementation
- All agent prompts in `docs/agents/*.md`

## Anti-Patterns to Avoid

- ❌ Starting engineering without all 5 prerequisites
- ❌ Skipping design phase
- ❌ Building without tests
- ❌ Ignoring edge cases
- ❌ Skipping a11y audit
- ❌ Large diffs (multiple concerns in one PR)
- ❌ Gold-plating features beyond PRD
- ❌ Missing UI states (loading, empty, error)
- ❌ No data capture instrumentation
- ❌ No expansion revenue implementation
