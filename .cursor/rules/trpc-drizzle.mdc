# tRPC & Drizzle Rules

## tRPC

### Procedure Definition
- Define procedures in feature modules under `data/` directory
- Use `publicProcedure` from `@/lib/trpc/init`
- Always validate inputs with Zod schemas
- Return typed responses

### Router Organization
- Group related procedures in feature routers
- Export feature routers from feature's `index.ts`
- Compose feature routers in `src/lib/trpc/router.ts`

### Error Handling
- Use tRPC error formatting (already configured)
- Return user-friendly error messages
- Log errors with context
- Use discriminated unions for error states

### Client Usage
- Use `trpc` hook from `@/lib/trpc/client` in components
- Prefer queries for reads, mutations for writes
- Handle loading and error states
- Use optimistic updates when appropriate

## Drizzle ORM

### Schema Definition
- Define schemas in `src/lib/db/schema.ts`
- Use Drizzle's type inference (`$inferSelect`, `$inferInsert`)
- Export types alongside schemas
- Use proper column types and constraints

### Queries
- Use Drizzle query builder (no raw SQL unless necessary)
- Use transactions for multi-step operations
- Always handle database errors
- Use prepared statements for repeated queries

### Migrations
- Generate migrations with `pnpm db:generate`
- Review migrations before applying
- Use `pnpm db:push` for development
- Use `pnpm db:migrate` for production

### Best Practices
- Keep queries simple and readable
- Use relations for joins (not manual joins)
- Index frequently queried columns
- Use transactions for data consistency
