# Architecture Rules

## Core Principles

### Boring, Evolutionary Architecture
- Prefer simple, maintainable solutions over clever abstractions
- Make small, verifiable changes
- Avoid premature optimization
- When architecture changes are needed, create an ADR in `docs/adr/`

### Feature Module Structure
- All features live in `src/features/<feature>/`
- Each feature has three layers:
  - `domain/` - Business logic, types, Zod schemas
  - `data/` - Server actions, tRPC procedures, API routes
  - `ui/` - React components
- Features export a public API via `index.ts`
- **No cross-feature imports** except through public APIs
- Shared utilities live in `src/lib/`

### Server-First Approach
- Prefer server actions and tRPC procedures over client mutations
- Use React Server Components by default
- Mark client components with `"use client"` only when needed
- Keep client components minimal and focused

## Type Safety

- TypeScript strict mode is always ON
- Never use `any` (explicit or implicit)
- Use Zod schemas for all input validation
- Create type guards for parsing unknown data (see `src/lib/type-guards.ts`)
- Use `noUncheckedIndexedAccess` for safer array/object access

## Database

- Use Drizzle ORM for all database operations
- Define schemas in `src/lib/db/schema.ts`
- Use connection pooling via `src/lib/db/index.ts`
- Never write raw SQL unless absolutely necessary
- Always use transactions for multi-step operations

## API Layer

- Use tRPC for type-safe APIs
- Define procedures in feature modules under `data/` directory
- Export procedures through feature's `index.ts`
- Use Zod for input/output validation
- Handle errors gracefully with proper error types
