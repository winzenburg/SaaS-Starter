# Platform & Operations Rules

## Next.js App Router

- **App Router only** - Use `src/app/` directory structure
- **Server Components by default** - Only use `"use client"` when needed
- **Route handlers** - Use for API endpoints (`src/app/api/**/route.ts`)
- **Server actions** - Prefer over client mutations
- **Metadata** - Use Next.js metadata API for SEO

## Vercel Platform

- **Default runtime Node.js; Edge only with ADR justification** - Use Node.js runtime by default
  - Edge runtime requires an Architecture Decision Record (ADR) in `docs/adr/`
  - Document why Edge is needed and what trade-offs are acceptable
- **Environment variables** - Use Vercel dashboard for secrets
- **Use feature flags for risky rollouts** - Use Vercel Feature Flags for any potentially risky changes
  - New features that could impact users
  - Performance-sensitive changes
  - Breaking changes or migrations
- **Cron jobs** - Use Vercel Cron (configure in `vercel.json`)
- **Observability** - Use Vercel Analytics and Speed Insights

## Deployment

- **Automatic deployments** - From `main` branch
- **Preview deployments** - From pull requests
- **Environment variables** - Set in Vercel dashboard
- **Build settings** - Use Vercel defaults unless justified

## Performance

- **Image optimization** - Use Next.js Image component
- **Font optimization** - Use Next.js font optimization
- **Code splitting** - Automatic with App Router
- **Caching** - Use appropriate cache strategies

## API Routes

- **Route handlers** - Use for REST endpoints
- **tRPC** - Use for type-safe APIs (preferred)
- **Error handling** - Return proper HTTP status codes
- **Validation** - Validate all inputs with Zod

## tRPC

### Procedure Definition
- Define procedures in feature modules under `data/` directory
- Use `publicProcedure` from `@/lib/trpc/init`
- Always validate inputs with Zod schemas
- Return typed responses

### Router Organization
- Group related procedures in feature routers
- Export feature routers from feature's `index.ts`
- Compose feature routers in `src/lib/trpc/router.ts`

### Error Handling
- Use tRPC error formatting (already configured)
- Return user-friendly error messages
- Log errors with context
- Use discriminated unions for error states

### Client Usage
- Use `trpc` hook from `@/lib/trpc/client` in components
- Prefer queries for reads, mutations for writes
- Handle loading and error states
- Use optimistic updates when appropriate

## Drizzle ORM

### Schema Definition
- Define schemas in `src/lib/db/schema.ts`
- Use Drizzle's type inference (`$inferSelect`, `$inferInsert`)
- Export types alongside schemas
- Use proper column types and constraints

### Queries
- Use Drizzle query builder (no raw SQL unless necessary)
- Use transactions for multi-step operations
- Always handle database errors
- Use prepared statements for repeated queries

### Migrations
- Generate migrations with `pnpm db:generate`
- Review migrations before applying
- Use `pnpm db:push` for development
- Use `pnpm db:migrate` for production

### Best Practices
- Keep queries simple and readable
- Use relations for joins (not manual joins)
- Index frequently queried columns
- Use transactions for data consistency

## Code Formatting

- Use Prettier for code formatting (`pnpm format`)
- Run Prettier before committing
- ESLint handles code quality, Prettier handles style
- Follow existing patterns in the codebase

## Server Actions

- **Emit observability events on server actions** - All server actions must emit observability events
  - Log start/completion of actions
  - Track errors and performance metrics
  - Use structured logging for better debugging
  - Integrate with Vercel Observability or similar

## Error Handling

- **Always handle errors** - No unhandled promises or try/catch blocks
- **User-friendly messages** - Errors should be clear and actionable
- **Logging** - Log errors with context for debugging
- **Type-safe errors** - Use discriminated unions for error states

## Security

### Stripe Webhooks
- **Stripe webhooks verify signatures** - Always verify webhook signatures
  - Use `stripe.webhooks.constructEvent()` to verify signatures
  - Never process webhooks without signature verification
  - Return appropriate error codes for invalid signatures
- **No PII in logs** - Never log personally identifiable information
  - Don't log credit card numbers, SSNs, passwords, or other sensitive data
  - Use identifiers or hashed values instead
  - Be careful with email addresses and names in logs
  - Follow data privacy regulations (GDPR, CCPA, etc.)
